# kraken_flu
This tool takes care of the modifications that need to be made to KRAKEN2 database input files in order to build a KRAKEN2 database where the segments of influenza genomes appear as new taxa, one per segment. 

The default way of handling such genomes in KRAKEN2 is one taxon per genome.

## Installation
Install with pip. You will probably want to create a venv for this first.
```shell
pip install kraken_flu@git+ssh://git@gitlab.internal.sanger.ac.uk/malariagen1/misc_utils/kraken_flu.git
```

## Usage
Once installed, run with the following command:

```shell
kraken_flu build --taxonomy_path FILE --library_path FILE [--acc2tax_path ACC2TAX_PATH] --out_dir OUT_DIR
```

Get help:
```shell
kraken_flu -h
```


### Example database creation
Use kraken2 build tools to download taxonomy and genome sequence data to build a database. 

Step 1: obtain the taxonomy files. These are retrieved from [NCBI](https://ftp.ncbi.nlm.nih.gov/pub/taxonomy/) by the kraken tool.
```shell
kraken2-build \
    --download-taxonomy \
    --db SOME/PATH/
```
This command creates a directory SOME/PATH/taxonomy

Step 2: download genome data. In this case, using kraken2 to download a prebuilt version of NCBI RefSeq for the virus division.  

```shell
kraken2-build \
    --download-library viral \
    --db SOME/PATH/
```
This command creates a directory SOME/PATH/library/viral

Step 3: Use the kraken_flu __build__ tool to scan the files created above and re-assign influenza H1N1 and H3N2 virus genome segments to new taxa, one segment per taxon ID.   
The tool will create a new directory with the modified versions of the taxonomy and library (FASTA) files. The paths are taken from the above example kraken2 build commands.  

```shell
kraken_flu build \
    --taxonomy_path SOME/PATH/taxonomy \
    --library_path SOME/PATH/library/viral \
    --out_dir SOME/OUTPUT/DIR
```

Step 4: use kraken2 to build the database from the modified files  

```shell
kraken2-build \
    --build \
    --db  SOME/OUTPUT/DIR
```

Optional clean-up step: remove (potentially large) files that are no longer needed in the build directory.  

```shell
kraken2-build \
    --clean \
    --db SOME/OUTPUT/DIR
```

## Using the filter tool to pre-process large collections of flu genomes
A filter command is provided, which was designed to filter the large files of all influenza genomes that can be obtained from the [NCBI influenza FTP site](https://ftp.ncbi.nih.gov/genomes/INFLUENZA/) (file "influenza.fna").  

The filter produces a new FASTA file from the download, which only contains the genomes (identified by unique name) that have all 8 segments and at least 90% of the expected sequence length for each of them. In addition, the name of the sequence in the FASTA header must match the pattern ```Influenza [AB].+ segment [1-8]```.

This command creates the filtered FASTA file
```shell
kraken_flu filter \
    --in_fasta NCBI_FASTA_FILE \
    --out_fasta OUTPUT_FILE
```

The file generated by this command can be used as the input file to the ```kraken_flu build``` command as outlined [above](#example-database-creation).

